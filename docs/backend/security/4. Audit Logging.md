### 4.1 Overview

```directory
src/
└── app/
    └── class/
        └── Audit/
            └── AuditLogger.js
```

Database Table: AuditLog

Endpoint: `/api/audit_logs/`

Comprehensive audit logging captures all security-relevant events.

**Logging Examples** (`src/app/class/Audit/AuditLogger.js`):

```javascript
import AuditLogger from '@app/class/Audit/AuditLogger';

// Log CRUD operations
await AuditLogger.logCreate({
    userId: user.ID,
    email: user.Email,
    module: 'course_management',
    entity: 'Course',
    entityId: course.ID,
    after: { code: 'CSE101', title: 'Intro to Computing' },
    metadata: { source: 'admin_panel' },
    req: request
});

// Log role assignment
await AuditLogger.logRoleAssignment(
    userId,
    [roleId1, roleId2],
    assignedByEmail,
    'Assigned for new semester',
    request
);

// Log permission change
await AuditLogger.logPermissionChange(
    roleId,
    permissionId,
    true, // granted=true, denied=false
    changedByUserId,
    'Granted course:delete permission',
    request
);

// Log authentication event
await AuditLogger.logAuthentication(
    userId,
    'LOGIN',
    { ipAddress: clientIP, userAgent: userAgent },
    request
);

// Log update with before/after snapshots
await AuditLogger.logUpdate({
    userId: modifyingUserId,
    email: modifyingUserEmail,
    module: 'user_management',
    entity: 'UserProfile',
    entityId: profile.ID,
    before: { Status: 'active', Roles: ['Student'] },
    after: { Status: 'inactive', Roles: ['Student'] },
    reason: 'Account deactivation requested',
    req: request
});

// Retrieve audit logs with filters
const logs = await AuditLogger.getAuditLogs({
    userId: 5,
    action: 'UPDATE',
    module: 'role_management',
    startDate: '2025-01-01',
    endDate: '2025-12-31',
    limit: 100,
    offset: 0
});

// Get latest change for a specific entity
const latestChange = await AuditLogger.getLatestAuditForEntity(
    'course_management',
    'Course',
    'CSE101'
);

// Export audit logs to CSV
const csvData = await AuditLogger.exportAuditLogs(
    { startDate: '2025-01-01', module: 'authentication' },
    'csv'
);
```

### 4.2 Logged Events

**Authentication Events**:

- `LOGIN` - Successful user login
    
- `LOGOUT` - User logout
    
- `LOGIN_BLOCKED_INACTIVE` - Inactive user login attempt
    
- `USER_REGISTRATION` - New user created
    

**Role & Permission Management**:

- `ROLE_ASSIGNMENT` - User assigned to role
    
- `ROLE_REMOVAL` - User removed from role
    
- `ROLE_CREATION` - New role created
    
- `ROLE_MODIFICATION` - Role updated
    
- `ROLE_DELETION` - Role deleted
    
- `PERMISSION_CHANGE` - Permission granted/denied
    

**CRUD Operations**:

- `CREATE` - New resource created
    
- `READ` - Resource accessed
    
- `UPDATE` - Resource modified (with before/after snapshots)
    
- `DELETE` - Resource deleted
    

**System Events**:

- `SYSTEM_CONFIG_CHANGE` - Configuration updated
    

### 4.3 Audit Log Fields

| **Field**   | **Type**  | **Purpose**                 |
| ----------- | --------- | --------------------------- |
| `UserID`    | UUID      | Which user performed action |
| `Action`    | STRING    | What action was performed   |
| `Module`    | STRING    | Which system module         |
| `Details`   | JSON      | Additional context/metadata |
| `IPAddress` | STRING    | Client IP address           |
| `UserAgent` | STRING    | Browser/client identifier   |
| `CreatedAt` | TIMESTAMP | When event occurred         |

### 4.4 IP Address Tracking

**Priority Order** (highest to lowest):

1. `X-Forwarded-For` - Proxy/load balancer
    
2. `X-Real-IP` - Nginx reverse proxy
    
3. `X-Client-IP` - Standard client IP
    
4. `CF-Connecting-IP` - Cloudflare
    
5. `req.ip` - Express.js extracted IP
    
6. `req.socket.remoteAddress` - Direct connection
    

**Benefits**:

- Accurate client identification
    
- Tracking through proxies
    
- Compliance with audit requirements
    

### 4.5 Audit Log Export

**Formats**: JSON, CSV

**Use Cases**:

- Compliance reporting
    
- Security analysis
    
- Incident investigation
    
- User activity review
    

**API**: `/api/audit_logs/` with filtering options

### 4.6 Entity Change Tracking

**Related Endpoint**: `/api/audit_logs/latest_for_entity/`

**Features**:

- Retrieve latest changes for specific entity
    
- Track modification history
    
- Compare versions (diff calculation)
    
---
